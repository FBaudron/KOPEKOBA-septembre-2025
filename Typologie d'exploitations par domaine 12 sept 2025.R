#' ---
#' title: "Typologie d'exploitations"
#' author: "Frédéric Baudron"
#' date: "12 septembre 2025"
#' ---


# CLEAR ENVIRONMENT-------------------------------------------------------------

rm(list = ls())


# LOADING NECESSARY PACKAGES----------------------------------------------------

library(openxlsx)
library(janitor)
library(FactoMineR)
library(factoextra)
library(vegan)
library(ade4)
library(dendextend)
library(ggdendro)
library(gtsummary)
library(randomForest)
library(dplyr)
library(sf)
library(terra)
library(geodata)
library(ggpubr)
library(tidyverse)
library(rpart)
library(partykit)
library(ggparty)
library(cluster)
library(inspectdf)
library(NbClust)
library(gt)


# SETTING UP THE DIRECTORY & LOADING THE DATA-----------------------------------

setwd("D:\\Mes Donnees\\1. Cirad\\5. PUDT\\Enquête\\")


loc = read.xlsx("Input_files\\1.1. Localisation avec types esquisse.xlsx", sheet = 1)
enq = read.xlsx("Input_files\\2. Enquêté.xlsx", sheet = 1)
chf = read.xlsx("Input_files\\3.2. Chef de famille.xlsx", sheet = 1)
hst = read.xlsx("Input_files\\4. Histoire.xlsx", sheet = 1)
sec = read.xlsx("Input_files\\5. Sécurité alimentaire.xlsx", sheet = 1)
agr = read.xlsx("Input_files\\6.1. Agriculture générale.xlsx", sheet = 1)
div = read.xlsx("Input_files\\6.3. Diversité cultures.xlsx", sheet = 1)
man = read.xlsx("Input_files\\6.4.1. Manioc.xlsx", sheet = 1)
mai = read.xlsx("Input_files\\6.4.2. Maïs.xlsx", sheet = 1)
soj = read.xlsx("Input_files\\6.4.3. Soja.xlsx", sheet = 1)
ara = read.xlsx("Input_files\\6.4.4. Arachide.xlsx", sheet = 1)
saf = read.xlsx("Input_files\\6.4.5. Safou.xlsx", sheet = 1)
cac = read.xlsx("Input_files\\6.4.6. Cacao.xlsx", sheet = 1)
caf = read.xlsx("Input_files\\6.4.7. Café.xlsx", sheet = 1)
pla = read.xlsx("Input_files\\6.4.8. Plantain.xlsx", sheet = 1)
pal = read.xlsx("Input_files\\6.4.9. Palmier.xlsx", sheet = 1)
ori = read.xlsx("Input_files\\6.5. Orientation.xlsx", sheet = 1)
pre = read.xlsx("Input_files\\6.6. Précédent et status.xlsx", sheet = 1)
bet = read.xlsx("Input_files\\6.7.1. Production bétail.xlsx", sheet = 1)
psn = read.xlsx("Input_files\\6.7.2. Production poissons.xlsx", sheet = 1)
res = read.xlsx("Input_files\\6.8. Ressources naturelles.xlsx", sheet = 1)
rev = read.xlsx("Input_files\\7.1. Revenus principaux.xlsx", sheet = 1)
rvt = read.xlsx("Input_files\\7.2. Revenus totaux.xlsx", sheet = 1)
fct = read.xlsx("Input_files\\8.1. Force de travail.xlsx", sheet = 1)
dyn = read.xlsx("Input_files\\8.2. Dynamiques de l'exploitation.xlsx", sheet = 1)
eqt = read.xlsx("Input_files\\8.3 Equipement.xlsx", sheet = 1)
acc = read.xlsx("Input_files\\9.1. Accompagnement.xlsx", sheet = 1)
ctr = read.xlsx("Input_files\\9.2. Contrats.xlsx", sheet = 1)
mch = read.xlsx("Input_files\\9.3. Distance au marché.xlsx", sheet = 1)
psp = read.xlsx("Input_files\\10. Perspectives.xlsx", sheet = 1)


# names(enq)
enq = enq[, c(1, 4, 23)]
# names(chf)
chf = chf[, c(1, 3:4)]
# names(hst)
hst = hst[, c(1:2)]
# names(sec)
sec = sec[, c(1, 3)]
# names(agr)
agr = agr[, c(1:2, 4, 6, 9:10)]
# names(div)
div = div[, c(1:5, 20:22, 24:25, 34:37)]
# names(man)
man = man[, c(1, 66:69)]
# names(mai)
mai = mai[, c(1, 46:49)]
# names(soj)
soj = soj[, c(1, 41:44)]
# names(ara)
ara = ara[, c(1, 42:45)]
# names(saf)
saf = saf[, c(1, 21:22)]
# names(cac)
cac = cac[, c(1, 12, 23)]
# names(caf)
caf = caf[, c(1, 11, 22)]
# names(pla)
pla = pla[, c(1, 12:15)]
# names(pal)
pal = pal[, c(1, 34:35)]
# names(ori)
ori = ori[, c(1, 15)]
# names(pre)
pre = pre[, c(1:2, 4:5)]
# names(bet)
bet = bet[, c(1:11, 23, 27:30)]
# names(psn)
psn = psn[, c(1:2)]
# names(res)
res = res[, c(1:2, 4, 6, 18:28, 31)]
# names(rev)
rev = rev[, c(1:2)]
# names(rvt)
rvt$revenu_agricole = rvt$revenu_agricole + rvt$revenu_elevage + rvt$revenu_pisciculture
rvt$revenu_res_nat = rvt$revenu_peche + rvt$revenu_chasse + rvt$revenu_cueillette + rvt$revenu_orpaillage + rvt$revenu_exploitation_forestiere
rvt$autre = rvt$revenu_boutique + rvt$revenu_ouvrier + rvt$revenu_employe + rvt$revenu_cadre + rvt$revenu_autre
rvt = rvt[, c(1:2, 17, 15)]
# names(fct)
fct = fct[, c(1:3)]
# names(dyn)
dyn = dyn[, c(1:2, 11)]
# names(eqt)
eqt$voit_kav_mot_usage = eqt$voiture_usage + eqt$kavaki_usage + eqt$moto_usage
eqt$voit_kav_mot_usage = ifelse(eqt$voit_kav_mot_usage > 0, 1, 0)
eqt = eqt[, c(1:2, 31, 30, 19, 27:28)]
# names(acc)
acc = acc[, c(1:2)]
# names(ctr)
ctr = ctr[, c(1:2)]
# names(mch)
mch = mch[, c(1:5)]
# names(psp)

typo = merge(loc, enq, by = "id", all.x = TRUE)
typo = merge(typo, chf, by = "id", all.x = TRUE)
typo = merge(typo, hst, by = "id", all.x = TRUE)
typo = merge(typo, sec, by = "id", all.x = TRUE)
typo = merge(typo, agr, by = "id", all.x = TRUE)
typo = merge(typo, div, by = "id", all.x = TRUE)
typo = merge(typo, man, by = "id", all.x = TRUE)
typo = merge(typo, mai, by = "id", all.x = TRUE)
typo = merge(typo, soj, by = "id", all.x = TRUE)
typo = merge(typo, ara, by = "id", all.x = TRUE)
typo = merge(typo, saf, by = "id", all.x = TRUE)
typo = merge(typo, cac, by = "id", all.x = TRUE)
typo = merge(typo, caf, by = "id", all.x = TRUE)
typo = merge(typo, pla, by = "id", all.x = TRUE)
typo = merge(typo, pal, by = "id", all.x = TRUE)
typo = merge(typo, ori, by = "id", all.x = TRUE)
typo = merge(typo, pre, by = "id", all.x = TRUE)
typo = merge(typo, bet, by = "id", all.x = TRUE)
typo = merge(typo, psn, by = "id", all.x = TRUE)
typo = merge(typo, res, by = "id", all.x = TRUE)
typo = merge(typo, rev, by = "id", all.x = TRUE)
typo = merge(typo, rvt, by = "id", all.x = TRUE)
typo = merge(typo, fct, by = "id", all.x = TRUE)
typo = merge(typo, dyn, by = "id", all.x = TRUE)
typo = merge(typo, eqt, by = "id", all.x = TRUE)
typo = merge(typo, acc, by = "id", all.x = TRUE)
typo = merge(typo, ctr, by = "id", all.x = TRUE)
typo = merge(typo, mch, by = "id", all.x = TRUE)
typo = merge(typo, psp, by = "id", all.x = TRUE)


typo$education_chef_fam = ifelse(typo$education_chef_fam == "Aucun", 0,
                                 ifelse(typo$education_chef_fam == "Education primaire", 0, 1))

typo$jachere = ifelse(typo$jachere > 0, 1, 0)

typo$surface_louee = ifelse(typo$surface_louee > 0, 1, 0)

typo$manioc_production = ifelse(typo$manioc_production > 0, 1, 0)

typo$bovins = ifelse(typo$bovins > 0, 1, 0)
typo$porcs = ifelse(typo$porcs > 0, 1, 0)
typo$petits_ruminants = ifelse(typo$petits_ruminants > 0, 1, 0)
typo$volailles = ifelse(typo$volailles > 0, 1, 0)
typo$ubt = ifelse(typo$ubt > 0, 1, 0)

typo$oeuf_productivite[is.na(typo$oeuf_productivite)] = 0
typo$oeuf_productivite = ifelse(typo$oeuf_productivite > 0, 1, 0)

typo$alim_appoint_bovins[is.na(typo$alim_appoint_bovins)] = 0
typo$alim_appoint_petits_ruminants[is.na(typo$alim_appoint_petits_ruminants)] = 0
typo$alim_appoint_porcs[is.na(typo$alim_appoint_porcs)] = 0
typo$alim_appoint_volailles[is.na(typo$alim_appoint_volailles)] = 0

typo$alim = typo$alim_appoint_bovins + typo$alim_appoint_petits_ruminants +
  typo$alim_appoint_porcs + typo$alim_appoint_volailles

typo$alim = ifelse(typo$alim > 0, 1, 0)

typo$nb_etangs = ifelse(typo$nb_etangs > 0, 1, 0)

typo$nb_pfnl = typo$chasse + typo$peche + typo$charbon + typo$miel + typo$fruits +
  typo$feuilles + typo$asperges + typo$rotins + typo$ecorces + typo$poivre + typo$seve +
  typo$seve + typo$noix + typo$chenilles + typo$champignons

typo$source_rev_1 = as.numeric(typo$source_rev_1 == "Agriculture")

typo$evolution_surf_cult_passe = as.numeric(typo$evolution_surf_cult_passe == "Augmenté")

typo$eqp_value = ifelse(typo$eqp_value > 0, 1, 0)

typo$ou_vendez_vous_vos_produits_village[is.na(typo$ou_vendez_vous_vos_produits_village)] = 0
typo$ou_vendez_vous_vos_produits_goudron[is.na(typo$ou_vendez_vous_vos_produits_goudron)] = 0
typo$ou_vendez_vous_vos_produits_chef_lieu_district_ou_departement[is.na(typo$ou_vendez_vous_vos_produits_chef_lieu_district_ou_departement)] = 0
typo$ou_vendez_vous_vos_produits_brazzaville_pointe_noire[is.na(typo$ou_vendez_vous_vos_produits_brazzaville_pointe_noire)] = 0

typo$reprise = as.numeric(typo$reprise == "Oui")

typo$statut_champ = ifelse(typo$statut_champ == "Propriété", 1, 0)

route = terra::rast('D:\\Mes Donnees\\1. Cirad\\5. PUDT\\Geo\\input-data\\road\\Distance_route_OSM.tif')

# plot(route)

typo_spatial = typo %>%
  sf::st_as_sf(coords = c("longitude", "latitude")) %>%
  sf::st_set_crs(4326)

typo = cbind(typo, terra::extract(route, terra::vect(typo_spatial)))

names(typo)[122] = "distance_route"

typo = typo[, -c(121)]


typo$previous_vegetation = ifelse(typo$previous_vegetation == "Savane arbustive" | typo$previous_vegetation == "Savane herbacée", "Savane", typo$previous_vegetation)
typo$previous_vegetation = ifelse(typo$previous_vegetation == "1", "Forêt dégradée", typo$previous_vegetation)
typo$previous_vegetation = ifelse(typo$previous_vegetation == "2", "Forêt dense", typo$previous_vegetation)

typo$fallow_duration_simplifie = ifelse(typo$fallow_duration_simplifie == "6-11 ans" | typo$fallow_duration_simplifie == "12 ans et +",
                                        "6 ans et +", typo$fallow_duration_simplifie)
typo$fallow_duration_simplifie = ifelse(typo$fallow_duration_simplifie == "1", "1-5 ans", typo$fallow_duration_simplifie)
typo$fallow_duration_simplifie = ifelse(typo$fallow_duration_simplifie == "4", "Pas de jachère", typo$fallow_duration_simplifie)


typo$type2 =  ifelse(typo$type == "défriche (10 - 30 %) sur couvert forestier discontinu", "Défriche dense sous couvert forestier discontinu", NA)
typo$type2 =  ifelse(typo$type == "défriche dense (+ de 30 %) sur couvert forestier discontinu", "Défriche dense sous couvert forestier discontinu", typo$type2)
typo$type2 =  ifelse(typo$type == "défriche forestière (25-50%)", "Défriche en zone forestière", typo$type2)
typo$type2 =  ifelse(typo$type == "défriche forestière dense (+ de 50%)", "Défriche en zone forestière", typo$type2)
typo$type2 =  ifelse(typo$type == "défriche forestière peu dense (- de 25%)", "Défriche en zone forestière", typo$type2)
typo$type2 =  ifelse(typo$type == "défriche marginale sur couvert forestier discontinu", "Défriche marginale sous couvert forestier discontinu", typo$type2)
typo$type2 =  ifelse(typo$type == "défriche peu dense (- de 10%) sur couvert forestier discontinu", "Défriche marginale sous couvert forestier discontinu", typo$type2)
typo$type2 =  ifelse(typo$type == "parcellaire mécanisé", "Agriculture de savane des Plateaux Batéké", typo$type2)
typo$type2 =  ifelse(typo$type == "parcellaire mécanisé récent (après 2015)", "Agriculture de savane des Plateaux Batéké", typo$type2)
typo$type2 =  ifelse(typo$type == "petit parcellaire dense", "Agriculture de savane de la vallée du Niari", typo$type2)
typo$type2 = ifelse(typo$district == "Lékana", "Agriculture de savane des Plateaux Batéké", typo$type2) #Important, on réintégre les villages du district de Lékane dans le paysage Plateaux Batéké


# Normalization of continuous variables

data_typo = typo

data_typo_plateaux_btk =  data_typo[which(data_typo$type2 == "Agriculture de savane des Plateaux Batéké"), ]
data_typo_vallee_Niari =  data_typo[which(data_typo$type2 == "Agriculture de savane de la vallée du Niari"), ]
data_typo_mosaique_dense =  data_typo[which(data_typo$type2 == "Défriche dense sous couvert forestier discontinu"), ]
data_typo_mosaique_marginale =  data_typo[which(data_typo$type2 == "Défriche marginale sous couvert forestier discontinu"), ]
data_typo_massifs_forestiers=  data_typo[which(data_typo$type2 == "Défriche en zone forestière"), ]

# write.xlsx(typo, file = "Data_typo.xlsx")

# hist(typo$taille_famille)
# hist(typo$age)
# hist(typo$cultivated_area)
typo$cultivated_area = log10(typo$cultivated_area + (0.5 * min(typo$cultivated_area[typo$cultivated_area > 0])))
# hist(typo$cultivated_area)
# hist(typo$diversite_annual)
typo$diversite_annual = log10(typo$diversite_annual + (0.5 * min(typo$diversite_annual[typo$diversite_annual > 0])))
# hist(typo$diversite_annual)
# hist(typo$diversite_perenial)
typo$diversite_perenial = log10(typo$diversite_perenial + (0.5 * min(typo$diversite_perenial[typo$diversite_perenial > 0])))
# hist(typo$diversite_perenial)
# hist(typo$diversite_total)
# hist(typo$revenu_agricole)
typo$revenu_agricole = log10(typo$revenu_agricole + (0.5 * min(na.omit(typo$revenu_agricole)[na.omit(typo$revenu_agricole) > 0])))
# hist(typo$revenu_agricole)
# hist(typo$revenu_res_nat)
typo$revenu_res_nat = log10(typo$revenu_res_nat + (0.5 * min(na.omit(typo$revenu_res_nat)[na.omit(typo$revenu_res_nat) > 0])))
# hist(typo$revenu_res_nat)
# hist(typo$revenu_autre)
typo$revenu_autre = log10(typo$revenu_autre + (0.5 * min(na.omit(typo$revenu_autre)[na.omit(typo$revenu_autre) > 0])))
# hist(typo$revenu_autre)
# hist(typo$distance_route)
typo$distance_route = log10(typo$distance_route + (0.5 * min(na.omit(typo$distance_route)[na.omit(typo$distance_route) > 0])))
# hist(typo$distance_route)



typo = typo[, c("id", "taille_famille", "age_chef_fam", "cultivated_area", "diversite_total", "diversite_annual",
                 "diversite_perenial", "revenu_agricole", "revenu_res_nat", "revenu_autre",
                 "foyer_femme", "education_chef_fam", "indigene", "jardin", "verger", 
                 "jachere", "surface_louee", "bovins", "porcs", "petits_ruminants", "volailles",
                 "securite_alim", "alim", "entraide", "main_doeuvre_ext", "groupement",
                 "contrat", "reprise", "manioc", "mais", "arachide", "safoutier", "cacao","cafe", "plantain",
                 "palmier", "evolution_surf_cult_passe", "evolution_surf_cult_future",
                 "charbon", "peche", "chasse", "orientation", "previous_vegetation",
                 "fallow_duration_simplifie", "statut_champ", "type2", "distance_route", "tracteur_usage", "voit_kav_mot_usage")]


typo_plateaux_btk =  typo[which(typo$type2 == "Agriculture de savane des Plateaux Batéké"), ]
typo_vallee_Niari =  typo[which(typo$type2 == "Agriculture de savane de la vallée du Niari"), ]
typo_massifs_forestiers =  typo[which(typo$type2 == "Défriche en zone forestière"), ]
typo_mosaique_dense =  typo[which(typo$type2 == "Défriche dense sous couvert forestier discontinu"), ]
typo_mosaique_marginale =  typo[which(typo$type2 == "Défriche marginale sous couvert forestier discontinu"), ]

typo = na.omit(typo)
typo_plateaux_btk = na.omit(typo_plateaux_btk )
typo_vallee_Niari = na.omit(typo_vallee_Niari)
typo_massifs_forestiers = na.omit(typo_massifs_forestiers )
typo_mosaique_dense = na.omit(typo_mosaique_dense )
typo_mosaique_marginale = na.omit(typo_mosaique_marginale )



# PLATEAUX BATEKES--------------------------------------------------------------

typo_plateaux_btk$previous_vegetation = as.factor(typo_plateaux_btk$previous_vegetation)
typo_plateaux_btk$fallow_duration_simplifie = as.factor(typo_plateaux_btk$fallow_duration_simplifie)

inspect_cat(typo_plateaux_btk) %>% show_plot()

table(typo_plateaux_btk$previous_vegetation)                                                  

typo_plateaux_btk$previous_vegetation2 = ifelse(typo_plateaux_btk$previous_vegetation == "Forêt dense / jamais mise en culture", 1, NA)
typo_plateaux_btk$previous_vegetation2 = ifelse(typo_plateaux_btk$previous_vegetation == "Forêt dégradée", 1, typo_plateaux_btk$previous_vegetation2)
typo_plateaux_btk$previous_vegetation2 = ifelse(typo_plateaux_btk$previous_vegetation == "Savane", 0, typo_plateaux_btk$previous_vegetation2)

table(typo_plateaux_btk$previous_vegetation2)   

data_typo_plateaux_btk$previous_vegetation2 = ifelse(data_typo_plateaux_btk$previous_vegetation == "Forêt dense / jamais mise en culture", 1, NA)
data_typo_plateaux_btk$previous_vegetation2 = ifelse(data_typo_plateaux_btk$previous_vegetation == "Forêt dégradée", 1, data_typo_plateaux_btk$previous_vegetation2)
data_typo_plateaux_btk$previous_vegetation2 = ifelse(data_typo_plateaux_btk$previous_vegetation == "Savane", 0, data_typo_plateaux_btk$previous_vegetation2)


# the scaled Euclidean dissimilarity between continuous variables
dEucs = vegdist(typo_plateaux_btk[, c("taille_famille", "age_chef_fam", "cultivated_area", "diversite_total",
                                      "revenu_agricole", "revenu_res_nat", "revenu_autre", "distance_route"
)], method = "gower") 

# dissimilarity between binary variables
dBin_ppls = dist.binary(typo_plateaux_btk[, c("foyer_femme", "education_chef_fam", "indigene",
                                              "jardin", "verger", 
                                              "jachere", "surface_louee", "porcs", "petits_ruminants", 
                                              "securite_alim", "alim", "entraide", "main_doeuvre_ext", "groupement",
                                              "contrat", "reprise", "mais", "arachide", "safoutier", "cacao","cafe", "plantain",
                                              "palmier", "evolution_surf_cult_passe", "evolution_surf_cult_future", "statut_champ", "orientation",
                                              "charbon", "peche", "chasse", "tracteur_usage", "voit_kav_mot_usage", "previous_vegetation2")], method = 2)

typo_plateaux_btk$fallow_duration_simplifie = as.factor(typo_plateaux_btk$fallow_duration_simplifie)


nobs <- length(typo_plateaux_btk$fallow_duration_simplifie)
d_jach <- matrix(NA, nobs, nobs)
for (i in 1:nobs){
  for (j in 1:nobs){
    d_jach[i,j] <- 1 - (typo_plateaux_btk$fallow_duration_simplifie[i] == typo_plateaux_btk$fallow_duration_simplifie[j])
  }
}
d_jach <- as.dist(d_jach)


# Combine the 4 categories of dissimilarities, weighted by number of variables in each dissimilarity
dAll = (8 * dEucs^2 + 33 * dBin_ppls^2 + d_jach^2) / 42

#Transforming the matrix of dissimilarities to a matrix of distances
distAll = sqrt(2 * dAll)
pco = cmdscale(distAll, eig = TRUE, k = 10) 
# cumsum(pco$eig) / sum(pco$eig) 
barplot(pco$eig[1:20])

# choosing 5 dimensions
pco_var = pco$points[, 1:5]

NbClust(pco_var, diss = dist(pco_var), distance = NULL, method = "complete")


hc_pco = hclust(dist(pco_var), method = "complete")
plot(hc_pco, hang = -1)
grpPCO = cutree(hc_pco, k = 3)

hdend = as.dendrogram(hc_pco)
hdend = color_branches(hdend, k = 3)
hdend = color_labels(hdend, k = 3)
plot(hdend)


ggd = as.ggdend(hdend) 

ggplot(ggd, labels = FALSE) +
  theme_classic() + 
  theme(panel.border = element_blank(),
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 10, face = "bold"))

ggsave("Typo exploitation Plateaux Batéké.jpeg", units = "cm", width = 20, height = 15, dpi = 320)


plot(pco$points[,1], pco$points[,2], col=grpPCO)
plot(pco$points[,1], pco$points[,3], col=grpPCO)
plot(pco$points[,2], pco$points[,3], col=grpPCO)

typo_plateaux_btk$type_farm = grpPCO

names(typo_plateaux_btk)

data_typo_plateaux_btk = merge(data_typo_plateaux_btk, typo_plateaux_btk[, c(1, 51)], by = "id", all.x = TRUE)

data_typo_plateaux_btk$type_farm = as.factor(data_typo_plateaux_btk$type_farm)

table(data_typo_plateaux_btk$type_farm)
table(data_typo_plateaux_btk$type_farm, data_typo_plateaux_btk$departement)


data_typo_plateaux_btk$type_farm = ifelse(data_typo_plateaux_btk$type_farm == "1", "Type 1",
                                          ifelse(data_typo_plateaux_btk$type_farm == "2", "Type 2", "Type 3"))

names(data_typo_plateaux_btk)

write.xlsx(data_typo_plateaux_btk[, c(1:2, 123)], file = "Typo Plateaux Batéké.xlsx")


# Interpretation de la typologies

data_typo_plateaux_btk$type_farm = as.factor(data_typo_plateaux_btk$type_farm)
data_typo_plateaux_btk$previous_vegetation = as.factor(data_typo_plateaux_btk$previous_vegetation)
data_typo_plateaux_btk$fallow_duration_simplifie = as.factor(data_typo_plateaux_btk$fallow_duration_simplifie)


rf_type = randomForest(type_farm ~ ., data = na.omit(data_typo_plateaux_btk[, c("taille_famille", "age_chef_fam", "cultivated_area", "diversite_total",
                                                                                "revenu_agricole", "revenu_res_nat", "revenu_autre",
                                                                                "foyer_femme", "education_chef_fam", "indigene",
                                                                                "jardin", "verger", 
                                                                                "jachere", "surface_louee", "porcs", "petits_ruminants", "volailles",
                                                                                "securite_alim", "alim", "entraide", "main_doeuvre_ext", "groupement",
                                                                                "contrat", "reprise", "mais", "arachide", "safoutier", "cacao","cafe", "plantain",
                                                                                "palmier", "evolution_surf_cult_passe", "evolution_surf_cult_future",
                                                                                "charbon", "peche", "chasse", "orientation", "previous_vegetation2",
                                                                                "fallow_duration_simplifie", "statut_champ", "distance_route", "type_farm",
                                                                                "tracteur_usage", "voit_kav_mot_usage")]), ntree = 1500)


print(rf_type)

imp_total = importance(rf_type)

varImpPlot(rf_type)

imp_df = imp_total %>%
  as.data.frame() %>%
  rownames_to_column("variable") %>%
  arrange(desc(MeanDecreaseGini)) %>%
  mutate(cum_importance = cumsum(MeanDecreaseGini) / sum(MeanDecreaseGini))

# Select all vars that explain at least 70% of importance
top_vars = imp_df %>%
  filter(cum_importance <= 0.7) %>%
  pull(variable)

# Keep only top predictors + farm type
df_top = data_typo_plateaux_btk %>%
  select(all_of(top_vars), type_farm)

# Create summary table with tests
# Continuous: median [p25, p75] + Kruskal–Wallis
# Categorical: counts + Chi-square / Fisher
tab = df_top %>%
  tbl_summary(
    by = type_farm,
    statistic = list(all_continuous() ~ "{median} [{p25}, {p75}]",
                     all_categorical() ~ "{p}%"),
    missing = "no") %>%
  add_p(test = all_continuous() ~ "kruskal.test") 

tab

gtsave(as_gt(tab), "Typo Sept 2025/Typo_plateaux.html")


# VALLEE DU NIARI---------------------------------------------------------------

typo_vallee_Niari$previous_vegetation = as.factor(typo_vallee_Niari$previous_vegetation)
typo_vallee_Niari$fallow_duration_simplifie = as.factor(typo_vallee_Niari$fallow_duration_simplifie)

inspect_cat(typo_vallee_Niari) %>% show_plot()

table(typo_vallee_Niari$previous_vegetation)                                                  

typo_vallee_Niari$previous_vegetation2 = ifelse(typo_vallee_Niari$previous_vegetation == "Forêt dense / jamais mise en culture", 1, NA)
typo_vallee_Niari$previous_vegetation2 = ifelse(typo_vallee_Niari$previous_vegetation == "Forêt dégradée", 1, typo_vallee_Niari$previous_vegetation2)
typo_vallee_Niari$previous_vegetation2 = ifelse(typo_vallee_Niari$previous_vegetation == "Savane", 0, typo_vallee_Niari$previous_vegetation2)

table(typo_vallee_Niari$previous_vegetation2)   

data_typo_vallee_Niari$previous_vegetation2 = ifelse(data_typo_vallee_Niari$previous_vegetation == "Forêt dense / jamais mise en culture", 1, NA)
data_typo_vallee_Niari$previous_vegetation2 = ifelse(data_typo_vallee_Niari$previous_vegetation == "Forêt dégradée", 1, data_typo_vallee_Niari$previous_vegetation2)
data_typo_vallee_Niari$previous_vegetation2 = ifelse(data_typo_vallee_Niari$previous_vegetation == "Savane", 0, data_typo_vallee_Niari$previous_vegetation2)


# the scaled Euclidean dissimilarity between continuous variables
dEucs = vegdist(typo_vallee_Niari[, c("taille_famille", "age_chef_fam", "cultivated_area", "diversite_total",
                                      "revenu_agricole", "revenu_res_nat", "revenu_autre", "distance_route"
)], method = "gower") 

# dissimilarity between binary variables
dBin_ppls = dist.binary(typo_vallee_Niari[, c("foyer_femme", "education_chef_fam", "indigene",
                                              "jardin", "verger", 
                                              "jachere", "surface_louee", "porcs", "petits_ruminants", 
                                              "securite_alim", "alim", "entraide", "main_doeuvre_ext", "groupement",
                                              "contrat", "reprise", "mais", "arachide", "safoutier", "cacao","cafe", "plantain",
                                              "palmier", "evolution_surf_cult_passe", "evolution_surf_cult_future", "statut_champ", "orientation",
                                              "charbon", "peche", "chasse", "tracteur_usage", "voit_kav_mot_usage", "previous_vegetation2")], method = 2)

typo_vallee_Niari$fallow_duration_simplifie = as.factor(typo_vallee_Niari$fallow_duration_simplifie)


nobs <- length(typo_vallee_Niari$fallow_duration_simplifie)
d_jach <- matrix(NA, nobs, nobs)
for (i in 1:nobs){
  for (j in 1:nobs){
    d_jach[i,j] <- 1 - (typo_vallee_Niari$fallow_duration_simplifie[i] == typo_vallee_Niari$fallow_duration_simplifie[j])
  }
}
d_jach <- as.dist(d_jach)


# Combine the 4 categories of dissimilarities, weighted by number of variables in each dissimilarity
dAll = (8 * dEucs^2 + 33 * dBin_ppls^2 + d_jach^2) / 42

#Transforming the matrix of dissimilarities to a matrix of distances
distAll = sqrt(2 * dAll)
pco = cmdscale(distAll, eig = TRUE, k = 10) 
# cumsum(pco$eig) / sum(pco$eig) 
barplot(pco$eig[1:20])

# choosing 5 dimensions
pco_var = pco$points[, 1:3]


NbClust(pco_var, diss = dist(pco_var), distance = NULL, method = "complete")


hc_pco = hclust(dist(pco_var), method = "complete")
plot(hc_pco, hang = -1)
grpPCO = cutree(hc_pco, k = 5)

hdend = as.dendrogram(hc_pco)
hdend = color_branches(hdend, k = 5)
hdend = color_labels(hdend, k = 5)
plot(hdend)


ggd = as.ggdend(hdend) 

ggplot(ggd, labels = FALSE) +
  theme_classic() + 
  theme(panel.border = element_blank(),
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 10, face = "bold"))

ggsave("Typo exploitation Vallée du Niari.jpeg", units = "cm", width = 20, height = 15, dpi = 320)


plot(pco$points[,1], pco$points[,2], col=grpPCO)
plot(pco$points[,1], pco$points[,3], col=grpPCO)
plot(pco$points[,2], pco$points[,3], col=grpPCO)

typo_vallee_Niari$type_farm = grpPCO

names(typo_vallee_Niari)

data_typo_vallee_Niari = merge(data_typo_vallee_Niari, typo_vallee_Niari[, c(1, 51)], by = "id", all.x = TRUE)

data_typo_vallee_Niari$type_farm = as.factor(data_typo_vallee_Niari$type_farm)

table(data_typo_vallee_Niari$type_farm)
table(data_typo_vallee_Niari$type_farm, data_typo_vallee_Niari$departement)
table(data_typo_vallee_Niari$type_farm, data_typo_vallee_Niari$type3)



data_typo_vallee_Niari$type_farm = ifelse(data_typo_vallee_Niari$type_farm == "1", "Type 1",
                                          ifelse(data_typo_vallee_Niari$type_farm == "2", "Type 2",
                                                 ifelse(data_typo_vallee_Niari$type_farm == "3", "Type 3",
                                                        ifelse(data_typo_vallee_Niari$type_farm == "4", "Type 4", "Type 5"))))

names(data_typo_vallee_Niari)

write.xlsx(data_typo_vallee_Niari[, c(1:2, 123)], file = "Typo Vallée du Niari.xlsx")


# Interpretation de la typologies

data_typo_vallee_Niari$type_farm = as.factor(data_typo_vallee_Niari$type_farm)
data_typo_vallee_Niari$previous_vegetation = as.factor(data_typo_vallee_Niari$previous_vegetation)
data_typo_vallee_Niari$fallow_duration_simplifie = as.factor(data_typo_vallee_Niari$fallow_duration_simplifie)


rf_type = randomForest(type_farm ~ ., data = na.omit(data_typo_vallee_Niari[, c("taille_famille", "age_chef_fam", "cultivated_area", "diversite_total",
                                                                                "revenu_agricole", "revenu_res_nat", "revenu_autre",
                                                                                "foyer_femme", "education_chef_fam", "indigene",
                                                                                "jardin", "verger", 
                                                                                "jachere", "surface_louee", "porcs", "petits_ruminants", "volailles",
                                                                                "securite_alim", "alim", "entraide", "main_doeuvre_ext", "groupement",
                                                                                "contrat", "reprise", "mais", "arachide", "safoutier", "cacao","cafe", "plantain",
                                                                                "palmier", "evolution_surf_cult_passe", "evolution_surf_cult_future",
                                                                                "charbon", "peche", "chasse", "orientation", "previous_vegetation2",
                                                                                "fallow_duration_simplifie", "statut_champ", "distance_route", "type_farm",
                                                                                "tracteur_usage", "voit_kav_mot_usage")]), ntree = 1500)


print(rf_type)

imp_total = importance(rf_type)

varImpPlot(rf_type)


imp_df = imp_total %>%
  as.data.frame() %>%
  rownames_to_column("variable") %>%
  arrange(desc(MeanDecreaseGini)) %>%
  mutate(cum_importance = cumsum(MeanDecreaseGini) / sum(MeanDecreaseGini))

# Select all vars that explain at least 70% of importance
top_vars = imp_df %>%
  filter(cum_importance <= 0.7) %>%
  pull(variable)

# Keep only top predictors + farm type
df_top = data_typo_vallee_Niari %>%
  select(all_of(top_vars), type_farm)

# Create summary table with tests
# Continuous: median [p25, p75] + Kruskal–Wallis
# Categorical: counts + Chi-square / Fisher
tab = df_top %>%
  tbl_summary(
    by = type_farm,
    statistic = list(all_continuous() ~ "{median} [{p25}, {p75}]",
                     all_categorical() ~ "{p}%"),
    missing = "no") %>%
  add_p(test = all_continuous() ~ "kruskal.test") 

tab

gtsave(as_gt(tab), "Typo Sept 2025/Typo_niari.html")


# MOSAIC DENSE------------------------------------------------------------------

typo_mosaique_dense$previous_vegetation = as.factor(typo_mosaique_dense$previous_vegetation)
typo_mosaique_dense$fallow_duration_simplifie = as.factor(typo_mosaique_dense$fallow_duration_simplifie)

inspect_cat(typo_mosaique_dense) %>% show_plot()

table(typo_mosaique_dense$fallow_duration_simplifie)                                                  


# the scaled Euclidean dissimilarity between continuous variables
dEucs = vegdist(typo_mosaique_dense[, c("taille_famille", "age_chef_fam", "cultivated_area", "diversite_total",
                                      "revenu_agricole", "revenu_res_nat", "revenu_autre", "distance_route"
)], method = "gower") 

# dissimilarity between binary variables
dBin_ppls = dist.binary(typo_mosaique_dense[, c("foyer_femme", "education_chef_fam", "indigene",
                                              "jardin", "verger", 
                                              "jachere", "surface_louee", "porcs", "petits_ruminants", 
                                              "securite_alim", "alim", "entraide", "main_doeuvre_ext", "groupement",
                                              "contrat", "reprise", "mais", "arachide", "safoutier", "cacao","cafe", "plantain",
                                              "palmier", "evolution_surf_cult_passe", "evolution_surf_cult_future", "statut_champ", "orientation",
                                              "charbon", "peche", "chasse", "tracteur_usage", "voit_kav_mot_usage")], method = 2)

typo_mosaique_dense$previous_vegetation = as.factor(typo_mosaique_dense$previous_vegetation)
typo_mosaique_dense$fallow_duration_simplifie = as.factor(typo_mosaique_dense$fallow_duration_simplifie)


nobs <- length(typo_mosaique_dense$previous_vegetation)
d_prev_veg <- matrix(NA, nobs, nobs)
for (i in 1:nobs){
  for (j in 1:nobs){
    d_prev_veg[i,j] <- 1 - (typo_mosaique_dense$previous_vegetation[i] == typo_mosaique_dense$previous_vegetation[j])
  }
}
d_prev_veg <- as.dist(d_prev_veg)


nobs <- length(typo_mosaique_dense$fallow_duration_simplifie)
d_jach <- matrix(NA, nobs, nobs)
for (i in 1:nobs){
  for (j in 1:nobs){
    d_jach[i,j] <- 1 - (typo_mosaique_dense$fallow_duration_simplifie[i] == typo_mosaique_dense$fallow_duration_simplifie[j])
  }
}
d_jach <- as.dist(d_jach)


# Combine the 4 categories of dissimilarities, weighted by number of variables in each dissimilarity
dAll = (8 * dEucs^2 + 32 * dBin_ppls^2 + d_prev_veg^2 + d_jach^2) / 42

#Transforming the matrix of dissimilarities to a matrix of distances
distAll = sqrt(2 * dAll)
pco = cmdscale(distAll, eig = TRUE, k = 10) 
# cumsum(pco$eig) / sum(pco$eig) 
barplot(pco$eig[1:20])

# choosing 5 dimensions
pco_var = pco$points[, 1:4]


NbClust(pco_var, diss = dist(pco_var), distance = NULL, method = "complete")


hc_pco = hclust(dist(pco_var), method = "complete")
plot(hc_pco, hang = -1)
grpPCO = cutree(hc_pco, k = 5)

hdend = as.dendrogram(hc_pco)
hdend = color_branches(hdend, k = 5)
hdend = color_labels(hdend, k = 5)
plot(hdend)


ggd = as.ggdend(hdend) 

ggplot(ggd, labels = FALSE) +
  theme_classic() + 
  theme(panel.border = element_blank(),
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 10, face = "bold"))

ggsave("Typo exploitation Mosaiques denses.jpeg", units = "cm", width = 20, height = 15, dpi = 320)


plot(pco$points[,1], pco$points[,2], col=grpPCO)
plot(pco$points[,1], pco$points[,3], col=grpPCO)
plot(pco$points[,2], pco$points[,3], col=grpPCO)

typo_mosaique_dense$type_farm = grpPCO

names(typo_mosaique_dense)

data_typo_mosaique_dense = merge(data_typo_mosaique_dense, typo_mosaique_dense[, c(1, 50)], by = "id", all.x = TRUE)

data_typo_mosaique_dense$type_farm = as.factor(data_typo_mosaique_dense$type_farm)

table(data_typo_mosaique_dense$type_farm)
table(data_typo_mosaique_dense$type_farm, data_typo_mosaique_dense$departement)


data_typo_mosaique_dense$type_farm = ifelse(data_typo_mosaique_dense$type_farm == "1", "Type 1",
                                          ifelse(data_typo_mosaique_dense$type_farm == "2", "Type 2",
                                                 ifelse(data_typo_mosaique_dense$type_farm == "3", "Type 3",
                                                        ifelse(data_typo_mosaique_dense$type_farm == "4", "Type 4", "Type 5"))))


names(data_typo_mosaique_dense)

write.xlsx(data_typo_mosaique_dense[, c(1:2, 122)], file = "Typo Mosaiques denses.xlsx")


# Interpretation de la typologies

data_typo_mosaique_dense$type_farm = as.factor(data_typo_mosaique_dense$type_farm)
data_typo_mosaique_dense$previous_vegetation = as.factor(data_typo_mosaique_dense$previous_vegetation)
data_typo_mosaique_dense$fallow_duration_simplifie = as.factor(data_typo_mosaique_dense$fallow_duration_simplifie)


rf_type = randomForest(type_farm ~ ., data = na.omit(data_typo_mosaique_dense[, c("taille_famille", "age_chef_fam", "cultivated_area", "diversite_total",
                                                                                "revenu_agricole", "revenu_res_nat", "revenu_autre",
                                                                                "foyer_femme", "education_chef_fam", "indigene",
                                                                                "jardin", "verger", 
                                                                                "jachere", "surface_louee", "porcs", "petits_ruminants", "volailles",
                                                                                "securite_alim", "alim", "entraide", "main_doeuvre_ext", "groupement",
                                                                                "contrat", "reprise", "mais", "arachide", "safoutier", "cacao","cafe", "plantain",
                                                                                "palmier", "evolution_surf_cult_passe", "evolution_surf_cult_future",
                                                                                "charbon", "peche", "chasse", "orientation", "previous_vegetation",
                                                                                "fallow_duration_simplifie", "statut_champ", "distance_route", "type_farm",
                                                                                "tracteur_usage", "voit_kav_mot_usage")]), ntree = 1500)


print(rf_type)

imp_total = importance(rf_type)

varImpPlot(rf_type)

imp_df = imp_total %>%
  as.data.frame() %>%
  rownames_to_column("variable") %>%
  arrange(desc(MeanDecreaseGini)) %>%
  mutate(cum_importance = cumsum(MeanDecreaseGini) / sum(MeanDecreaseGini))

# Select all vars that explain at least 70% of importance
top_vars = imp_df %>%
  filter(cum_importance <= 0.7) %>%
  pull(variable)

# Keep only top predictors + farm type
df_top = data_typo_mosaique_dense %>%
  select(all_of(top_vars), type_farm)

# Create summary table with tests
# Continuous: median [p25, p75] + Kruskal–Wallis
# Categorical: counts + Chi-square / Fisher
tab = df_top %>%
  tbl_summary(
    by = type_farm,
    statistic = list(all_continuous() ~ "{median} [{p25}, {p75}]",
                     all_categorical() ~ "{p}%"),
    type = list(revenu_res_nat ~ "continuous"),
    missing = "no") %>%
  add_p(test = all_continuous() ~ "kruskal.test") 

tab

gtsave(as_gt(tab), "Typo Sept 2025/Typo_mosaique_dense.html")


# MOSAIC MARGINALE--------------------------------------------------------------

typo_mosaique_marginale$previous_vegetation = as.factor(typo_mosaique_marginale$previous_vegetation)
typo_mosaique_marginale$fallow_duration_simplifie = as.factor(typo_mosaique_marginale$fallow_duration_simplifie)

inspect_cat(typo_mosaique_marginale) %>% show_plot()

table(typo_mosaique_marginale$previous_vegetation)                                                  


# the scaled Euclidean dissimilarity between continuous variables
dEucs = vegdist(typo_mosaique_marginale[, c("taille_famille", "age_chef_fam", "cultivated_area", "diversite_total",
                                        "revenu_agricole", "revenu_res_nat", "revenu_autre", "distance_route"
)], method = "gower") 

# dissimilarity between binary variables
dBin_ppls = dist.binary(typo_mosaique_marginale[, c("foyer_femme", "education_chef_fam", "indigene",
                                                "jardin", "verger", 
                                                "jachere", "surface_louee", "porcs", "petits_ruminants", 
                                                "securite_alim", "alim", "entraide", "main_doeuvre_ext", "groupement",
                                                "contrat", "reprise", "mais", "arachide", "safoutier", "cacao","cafe", "plantain",
                                                "palmier", "evolution_surf_cult_passe", "evolution_surf_cult_future", "statut_champ", "orientation",
                                                "charbon", "peche", "chasse", "tracteur_usage", "voit_kav_mot_usage")], method = 2)

typo_mosaique_marginale$previous_vegetation = as.factor(typo_mosaique_marginale$previous_vegetation)
typo_mosaique_marginale$fallow_duration_simplifie = as.factor(typo_mosaique_marginale$fallow_duration_simplifie)


nobs <- length(typo_mosaique_marginale$previous_vegetation)
d_prev_veg <- matrix(NA, nobs, nobs)
for (i in 1:nobs){
  for (j in 1:nobs){
    d_prev_veg[i,j] <- 1 - (typo_mosaique_marginale$previous_vegetation[i] == typo_mosaique_marginale$previous_vegetation[j])
  }
}
d_prev_veg <- as.dist(d_prev_veg)


nobs <- length(typo_mosaique_marginale$fallow_duration_simplifie)
d_jach <- matrix(NA, nobs, nobs)
for (i in 1:nobs){
  for (j in 1:nobs){
    d_jach[i,j] <- 1 - (typo_mosaique_marginale$fallow_duration_simplifie[i] == typo_mosaique_marginale$fallow_duration_simplifie[j])
  }
}
d_jach <- as.dist(d_jach)


# Combine the 4 categories of dissimilarities, weighted by number of variables in each dissimilarity
dAll = (8 * dEucs^2 + 32 * dBin_ppls^2 + d_prev_veg^2 + d_jach^2) / 42

#Transforming the matrix of dissimilarities to a matrix of distances
distAll = sqrt(2 * dAll)
pco = cmdscale(distAll, eig = TRUE, k = 10) 
# cumsum(pco$eig) / sum(pco$eig) 
barplot(pco$eig[1:20])

# choosing 5 dimensions
pco_var = pco$points[, 1:3]


NbClust(pco_var, diss = dist(pco_var), distance = NULL, method = "complete")


hc_pco = hclust(dist(pco_var), method = "complete")
plot(hc_pco, hang = -1)
grpPCO = cutree(hc_pco, k = 4)

hdend = as.dendrogram(hc_pco)
hdend = color_branches(hdend, k = 4)
hdend = color_labels(hdend, k = 4)
plot(hdend)


ggd = as.ggdend(hdend) 

ggplot(ggd, labels = FALSE) +
  theme_classic() + 
  theme(panel.border = element_blank(),
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 10, face = "bold"))

ggsave("Typo exploitation Mosaiques marginales.jpeg", units = "cm", width = 20, height = 15, dpi = 320)


plot(pco$points[,1], pco$points[,2], col=grpPCO)
plot(pco$points[,1], pco$points[,3], col=grpPCO)
plot(pco$points[,2], pco$points[,3], col=grpPCO)

typo_mosaique_marginale$type_farm = grpPCO

names(typo_mosaique_marginale)

data_typo_mosaique_marginale = merge(data_typo_mosaique_marginale, typo_mosaique_marginale[, c(1, 50)], by = "id", all.x = TRUE)

data_typo_mosaique_marginale$type_farm = as.factor(data_typo_mosaique_marginale$type_farm)

table(data_typo_mosaique_marginale$type_farm)
table(data_typo_mosaique_marginale$type_farm, data_typo_mosaique_marginale$departement)


data_typo_mosaique_marginale$type_farm = ifelse(data_typo_mosaique_marginale$type_farm == "1", "Type 1", 
                                                ifelse(data_typo_mosaique_marginale$type_farm == "2", "Type 2", 
                                                       ifelse(data_typo_mosaique_marginale$type_farm == "3","Type 3", "Type 4")))

names(data_typo_mosaique_marginale)

write.xlsx(data_typo_mosaique_marginale[, c(1:2, 122)], file = "Typo Mosaiques marginales.xlsx")


# Interpretation de la typologies

data_typo_mosaique_marginale$type_farm = as.factor(data_typo_mosaique_marginale$type_farm)
data_typo_mosaique_marginale$previous_vegetation = as.factor(data_typo_mosaique_marginale$previous_vegetation)
data_typo_mosaique_marginale$fallow_duration_simplifie = as.factor(data_typo_mosaique_marginale$fallow_duration_simplifie)


rf_type = randomForest(type_farm ~ ., data = na.omit(data_typo_mosaique_marginale[, c("taille_famille", "age_chef_fam", "cultivated_area", "diversite_total",
                                                                                  "revenu_agricole", "revenu_res_nat", "revenu_autre",
                                                                                  "foyer_femme", "education_chef_fam", "indigene",
                                                                                  "jardin", "verger", 
                                                                                  "jachere", "surface_louee", "porcs", "petits_ruminants", "volailles",
                                                                                  "securite_alim", "alim", "entraide", "main_doeuvre_ext", "groupement",
                                                                                  "contrat", "reprise", "mais", "arachide", "safoutier", "cacao","cafe", "plantain",
                                                                                  "palmier", "evolution_surf_cult_passe", "evolution_surf_cult_future",
                                                                                  "charbon", "peche", "chasse", "orientation", "previous_vegetation",
                                                                                  "fallow_duration_simplifie", "statut_champ", "distance_route", "type_farm",
                                                                                  "tracteur_usage", "voit_kav_mot_usage")]), ntree = 1500)


print(rf_type)

imp_total = importance(rf_type)

varImpPlot(rf_type)

imp_df = imp_total %>%
  as.data.frame() %>%
  rownames_to_column("variable") %>%
  arrange(desc(MeanDecreaseGini)) %>%
  mutate(cum_importance = cumsum(MeanDecreaseGini) / sum(MeanDecreaseGini))

# Select all vars that explain at least 70% of importance
top_vars = imp_df %>%
  filter(cum_importance <= 0.7) %>%
  pull(variable)

# Keep only top predictors + farm type
df_top = data_typo_mosaique_marginale %>%
  select(all_of(top_vars), type_farm)

# Create summary table with tests
# Continuous: median [p25, p75] + Kruskal–Wallis
# Categorical: counts + Chi-square / Fisher
tab = df_top %>%
  tbl_summary(
    by = type_farm,
    statistic = list(all_continuous() ~ "{median} [{p25}, {p75}]",
                     all_categorical() ~ "{p}%"),
    missing = "no") %>%
  add_p(test = all_continuous() ~ "kruskal.test") 

tab

gtsave(as_gt(tab), "Typo Sept 2025/Typo_mosaique_marginale.html")


# MASSIFS FORESTIERS------------------------------------------------------------

typo_massifs_forestiers$previous_vegetation = as.factor(typo_massifs_forestiers$previous_vegetation)
typo_massifs_forestiers$fallow_duration_simplifie = as.factor(typo_massifs_forestiers$fallow_duration_simplifie)

inspect_cat(typo_massifs_forestiers) %>% show_plot()

table(typo_massifs_forestiers$previous_vegetation)                                                  


# the scaled Euclidean dissimilarity between continuous variables
dEucs = vegdist(typo_massifs_forestiers[, c("taille_famille", "age_chef_fam", "cultivated_area", "diversite_total",
                                            "revenu_agricole", "revenu_res_nat", "revenu_autre", "distance_route"
)], method = "gower") 

# dissimilarity between binary variables
dBin_ppls = dist.binary(typo_massifs_forestiers[, c("foyer_femme", "education_chef_fam", "indigene",
                                                    "jardin", "verger", 
                                                    "jachere", "surface_louee", "porcs", "petits_ruminants", 
                                                    "securite_alim", "alim", "entraide", "main_doeuvre_ext", "groupement",
                                                    "contrat", "reprise", "mais", "arachide", "safoutier", "cacao","cafe", "plantain",
                                                    "palmier", "evolution_surf_cult_passe", "evolution_surf_cult_future", "statut_champ", "orientation",
                                                    "charbon", "peche", "chasse", "tracteur_usage", "voit_kav_mot_usage")], method = 2)

typo_massifs_forestiers$previous_vegetation = as.factor(typo_massifs_forestiers$previous_vegetation)
typo_massifs_forestiers$fallow_duration_simplifie = as.factor(typo_massifs_forestiers$fallow_duration_simplifie)


nobs <- length(typo_massifs_forestiers$previous_vegetation)
d_prev_veg <- matrix(NA, nobs, nobs)
for (i in 1:nobs){
  for (j in 1:nobs){
    d_prev_veg[i,j] <- 1 - (typo_massifs_forestiers$previous_vegetation[i] == typo_massifs_forestiers$previous_vegetation[j])
  }
}
d_prev_veg <- as.dist(d_prev_veg)


nobs <- length(typo_massifs_forestiers$fallow_duration_simplifie)
d_jach <- matrix(NA, nobs, nobs)
for (i in 1:nobs){
  for (j in 1:nobs){
    d_jach[i,j] <- 1 - (typo_massifs_forestiers$fallow_duration_simplifie[i] == typo_massifs_forestiers$fallow_duration_simplifie[j])
  }
}
d_jach <- as.dist(d_jach)


# Combine the 4 categories of dissimilarities, weighted by number of variables in each dissimilarity
dAll = (8 * dEucs^2 + 32 * dBin_ppls^2 + d_prev_veg^2 + d_jach^2) / 42

#Transforming the matrix of dissimilarities to a matrix of distances
distAll = sqrt(2 * dAll)
pco = cmdscale(distAll, eig = TRUE, k = 10) 
# cumsum(pco$eig) / sum(pco$eig) 
barplot(pco$eig[1:20])

# choosing 5 dimensions
pco_var = pco$points[, 1:4]


NbClust(pco_var, diss = dist(pco_var), distance = NULL, method = "complete")


hc_pco = hclust(dist(pco_var), method = "complete")
plot(hc_pco, hang = -1)
grpPCO = cutree(hc_pco, k = 2)

hdend = as.dendrogram(hc_pco)
hdend = color_branches(hdend, k = 2)
hdend = color_labels(hdend, k = 2)
plot(hdend)


ggd = as.ggdend(hdend) 

ggplot(ggd, labels = FALSE) +
  theme_classic() + 
  theme(panel.border = element_blank(),
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 10, face = "bold"))

ggsave("Typo exploitation Massifs forestiers.jpeg", units = "cm", width = 20, height = 15, dpi = 320)


plot(pco$points[,1], pco$points[,2], col=grpPCO)
plot(pco$points[,1], pco$points[,3], col=grpPCO)
plot(pco$points[,2], pco$points[,3], col=grpPCO)

typo_massifs_forestiers$type_farm = grpPCO

names(typo_massifs_forestiers)

data_typo_massifs_forestiers = merge(data_typo_massifs_forestiers, typo_massifs_forestiers[, c(1, 50)], by = "id", all.x = TRUE)

data_typo_massifs_forestiers$type_farm = as.factor(data_typo_massifs_forestiers$type_farm)

table(data_typo_massifs_forestiers$type_farm)
table(data_typo_massifs_forestiers$type_farm, data_typo_massifs_forestiers$departement)


data_typo_massifs_forestiers$type_farm = ifelse(data_typo_massifs_forestiers$type_farm == "1", "Type 1", "Type 2")

names(data_typo_massifs_forestiers)

write.xlsx(data_typo_massifs_forestiers[, c(1:2, 122)], file = "Typo massifs forestiers.xlsx")


# Interpretation de la typologies

data_typo_massifs_forestiers$type_farm = as.factor(data_typo_massifs_forestiers$type_farm)
data_typo_massifs_forestiers$previous_vegetation = as.factor(data_typo_massifs_forestiers$previous_vegetation)
data_typo_massifs_forestiers$fallow_duration_simplifie = as.factor(data_typo_massifs_forestiers$fallow_duration_simplifie)


rf_type = randomForest(type_farm ~ ., data = na.omit(data_typo_massifs_forestiers[, c("taille_famille", "age_chef_fam", "cultivated_area", "diversite_total",
                                                                                      "revenu_agricole", "revenu_res_nat", "revenu_autre",
                                                                                      "foyer_femme", "education_chef_fam", "indigene",
                                                                                      "jardin", "verger", 
                                                                                      "jachere", "surface_louee", "porcs", "petits_ruminants", "volailles",
                                                                                      "securite_alim", "alim", "entraide", "main_doeuvre_ext", "groupement",
                                                                                      "contrat", "reprise", "mais", "arachide", "safoutier", "cacao","cafe", "plantain",
                                                                                      "palmier", "evolution_surf_cult_passe", "evolution_surf_cult_future",
                                                                                      "charbon", "peche", "chasse", "orientation", "previous_vegetation",
                                                                                      "fallow_duration_simplifie", "statut_champ", "distance_route", "type_farm",
                                                                                      "tracteur_usage", "voit_kav_mot_usage")]), ntree = 1500)


print(rf_type)

imp_total = importance(rf_type)

varImpPlot(rf_type)

imp_df = imp_total %>%
  as.data.frame() %>%
  rownames_to_column("variable") %>%
  arrange(desc(MeanDecreaseGini)) %>%
  mutate(cum_importance = cumsum(MeanDecreaseGini) / sum(MeanDecreaseGini))

# Select all vars that explain at least 70% of importance
top_vars = imp_df %>%
  filter(cum_importance <= 0.7) %>%
  pull(variable)

# Keep only top predictors + farm type
df_top = data_typo_massifs_forestiers %>%
  select(all_of(top_vars), type_farm)

# Create summary table with tests
# Continuous: median [p25, p75] + Kruskal–Wallis
# Categorical: counts + Chi-square / Fisher
tab = df_top %>%
  tbl_summary(
    by = type_farm,
    statistic = list(all_continuous() ~ "{median} [{p25}, {p75}]",
                     all_categorical() ~ "{p}%"),
    missing = "no") %>%
  add_p(test = all_continuous() ~ "kruskal.test") 

tab

gtsave(as_gt(tab), "Typo Sept 2025/Typo_foret.html")



